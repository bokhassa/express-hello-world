pipeline {
    agent any

    environment {
        AWS_REGION     = 'eu-west-3'
        AWS_ACCOUNT_ID = '651706762987'
        ECR_REPO_NAME  = 'hello-node-repo'
        IMAGE_TAG      = "${env.BUILD_NUMBER}"
        ECR_REGISTRY   = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        ECR_IMAGE_URI  = "${ECR_REGISTRY}/${ECR_REPO_NAME}:${IMAGE_TAG}"

        EC2_DEPLOY_USER = 'ec2-user'
        EC2_DEPLOY_HOST = '3.93.23.158'
    }

    options {
        timestamps()
    }

    stages {

        stage('Pipeline Colored') {
            steps {
                ansiColor('xterm') {
                    echo "Couleurs activ√©es ‚úîÔ∏è"
                }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install & Test (Node.js in Docker)') {
            steps {
                ansiColor('xterm') {
                    script {
                        docker.image('node:18').inside {
                            sh '''
                                echo "==> Using Node.js inside Docker"
                                node -v
                                npm -v
                                npm install
                                npm test || echo "Tests √©chou√©s mais on continue"
                            '''
                        }
                    }
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                ansiColor('xterm') {
                    sh '''
                        docker build -t ${ECR_IMAGE_URI} .
                    '''
                }
            }
        }

        stage('Login ECR') {
            steps {
                ansiColor('xterm') {
                    withCredentials([aws(credentialsId: 'aws-creds', region: "${AWS_REGION}")]) {
                        sh '''
                            aws ecr get-login-password --region ${AWS_REGION} \
                                | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                        '''
                    }
                }
            }
        }

        stage('Push Image') {
            steps {
                ansiColor('xterm') {
                    sh '''
                        docker push ${ECR_IMAGE_URI}
                    '''
                }
            }
        }

        stage('Deploy to EC2') {
            steps {
                ansiColor('xterm') {
                    sshagent(credentials: ['ec2-ssh-key']) {
                        sh '''
                            ssh -o StrictHostKeyChecking=no ${EC2_DEPLOY_USER}@${EC2_DEPLOY_HOST} "
                                aws ecr get-login-password --region ${AWS_REGION} \
                                    | docker login --username AWS --password-stdin ${ECR_REGISTRY}

                                docker pull ${ECR_IMAGE_URI}
                                docker rm -f hello-node || true
                                docker run -d --name hello-node -p 80:3000 ${ECR_IMAGE_URI}
                            "
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            echo "D√©ploiement r√©ussi ! üöÄ"
        }
        failure {
            echo "Erreur pendant le pipeline ‚ùå"
        }
    }
}
