pipeline {
    agent any

    environment {
        AWS_REGION     = 'eu-west-3'
        AWS_ACCOUNT_ID = '651706762987'       // <-- mets ton Account ID si différent
        ECR_REPO_NAME  = 'hello-node-repo'
        IMAGE_TAG      = "${env.BUILD_NUMBER}"
        ECR_REGISTRY   = "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        ECR_IMAGE_URI  = "${ECR_REGISTRY}/${ECR_REPO_NAME}:${IMAGE_TAG}"

        // Machine de déploiement (EC2 avec Docker installé)
        EC2_DEPLOY_USER = 'ec2-user'          // ou 'ubuntu' selon ton AMI
        EC2_DEPLOY_HOST = '3.93.23.158'       // <-- IP publique de ta machine de déploiement
    }

    options {
        timestamps()
        ansiColor('xterm')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install & Test') {
            steps {
                sh '''
                  echo "==> Installation des dépendances Node.js"
                  npm install

                  echo "==> Lancement des tests (non bloquant)"
                  npm test || echo "Les tests ont échoué mais on continue (projet pédagogique)"
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                  echo "==> Build de l'image Docker ${ECR_IMAGE_URI}"
                  docker build -t ${ECR_IMAGE_URI} .
                '''
            }
        }

        stage('Login to ECR') {
            steps {
                withCredentials([aws(credentialsId: 'aws-creds', region: "${AWS_REGION}")]) {
                    sh '''
                      echo "==> Login à ECR"
                      aws ecr get-login-password --region ${AWS_REGION} \
                        | docker login --username AWS --password-stdin ${ECR_REGISTRY}
                    '''
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                sh '''
                  echo "==> Push de l'image Docker vers ECR"
                  docker push ${ECR_IMAGE_URI}
                '''
            }
        }

        stage('Deploy to EC2 via SSH') {
            steps {
                sshagent(credentials: ['ec2-ssh-key']) {
                    sh '''
                      echo "==> Déploiement sur EC2 ${EC2_DEPLOY_HOST}"

                      ssh -o StrictHostKeyChecking=no ${EC2_DEPLOY_USER}@${EC2_DEPLOY_HOST} "
                        echo '==> Login Docker sur EC2'
                        aws ecr get-login-password --region ${AWS_REGION} \\
                          | docker login --username AWS --password-stdin ${ECR_REGISTRY} &&

                        echo '==> Pull de la nouvelle image'
                        docker pull ${ECR_IMAGE_URI} &&

                        echo '==> Stop + remove ancien conteneur (si existe)'
                        docker ps -q --filter \\"name=hello-node\\" | xargs -r docker stop || true
                        docker rm -f hello-node || true

                        echo '==> Lancement du nouveau conteneur'
                        docker run -d --name hello-node -p 80:3000 ${ECR_IMAGE_URI}
                      "
                    '''
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline terminé avec succès. Déploiement OK."
        }
        failure {
            echo "Pipeline en erreur. Vérifie les logs Jenkins."
        }
    }
}
